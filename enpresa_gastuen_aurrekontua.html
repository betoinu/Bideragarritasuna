<!DOCTYPE html>
<html lang="eu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Empresa Gastuen Aurrekontua (6 Fitxa)</title>
    <!-- Tailwind CSS kargatu -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f3f4f6;
    }
    .input-style {
        @apply w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150;
    }
    .table-header {
        @apply px-3 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider;
    }
    .result-card {
        @apply bg-white p-6 rounded-xl shadow-lg border-l-4;
    }
    /* Nabigazioa */
    .tab-container {
        display: grid;
        grid-template-columns: repeat(6, minmax(0, 1fr));
        gap: 4px;
    }
    .tab-button {
        @apply px-2 py-3 font-semibold rounded-t-lg transition duration-200 text-xs md:text-sm text-center truncate;
    }
    .tab-active {
        @apply text-white bg-indigo-600 shadow-md hover:bg-indigo-700;
    }
    .tab-inactive {
        @apply text-gray-600 bg-gray-200 hover:bg-gray-300;
    }
    /* Zenbaki-input-ean gezi estandarrak ezkutatu */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    </style>
</head>
<body>

<div class="max-w-7xl mx-auto p-4 md:p-8">
    <!-- Goiburua eta Titulua -->
    <header class="text-center mb-6 p-6 bg-white rounded-xl shadow-lg border-t-8 border-indigo-600">
        <div class="flex items-center justify-center space-x-4">
            <svg class="w-10 h-10 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 01-2-2V7a2 2 0 00-2-2h-2.5m-1.5 5.5l-2.5m0 0l2.5"></path>
            </svg>
            <h1 class="text-2xl md:text-3xl font-extrabold text-gray-800">ENPRESA GASTUEN AURREKONTUA (6 EREMU)</h1>
        </div>
        <p class="mt-2 text-lg text-gray-500">Gastu Finko, Aldakor, Pertsonal, Garraio, Hazkuntza Estrategikoen Estimazioa eta Finantzaketa</p>
    </header>
    
    <!-- Fitxen Nabigazioa -->
    <nav class="flex flex-col">
        <div class="tab-container p-2 bg-white rounded-t-xl shadow-md overflow-x-auto">
            <button id="tab-lokala" class="tab-button tab-active" onclick="showSheet('lokala')">
                1. Lokal/Inbertsio FINKOAK
            </button>
            <button id="tab-pertsonala" class="tab-button tab-inactive" onclick="showSheet('pertsonala')">
                2. Pertsonalaren Kostua (FINKOA)
            </button>
            <button id="tab-ekoizpena" class="tab-button tab-inactive" onclick="showSheet('ekoizpena')">
                3. Ekoizpen Aldakorrak
            </button>
            <button id="tab-garraioa" class="tab-button tab-inactive" onclick="showSheet('garraioa')">
                4. Garraioa
            </button>
            <button id="tab-hazkuntza" class="tab-button tab-inactive" onclick="showSheet('hazkuntza')">
                5. Hazkuntza/Marketina
            </button>
            <button id="tab-finantzaketa" class="tab-button tab-inactive" onclick="showSheet('finantzaketa')">
                6. Finantzaketa Mailegua
            </button>
        </div>
    </nav>
    
    <!-- KONTENEDORE NAGUSIA -->
    <section id="main-sheet" class="p-6 bg-white rounded-b-xl shadow-2xl space-y-12">
        
        <!-- ########################################## -->
        <!-- 1. LOKALAREN GASTU FINKOAK ETA INBERTSIOAK -->
        <!-- ########################################## -->
        <div id="lokala-sheet">
            <h2 class="text-2xl font-bold text-gray-700 mb-6 border-b pb-2 text-indigo-600">1. Lokalaren Gastu Finko Nagusiak eta Inbertsioak</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- A) INBERTSIO AMORTIZAGARRIAK TABLE -->
                <div class="lg:col-span-2 space-y-8">
                    <h3 class="text-xl font-semibold text-indigo-600 mb-4 flex items-center">
                        A) Inbertsio Amortizagarriak (Lokala & Ekipamendua)
                    </h3>
                    <div class="overflow-x-auto mb-8">
                        <table class="min-w-full divide-y divide-gray-200 rounded-xl overflow-hidden">
                            <thead class="bg-indigo-50">
                                <tr>
                                    <th class="table-header">Kontzeptua (AM)</th>
                                    <th class="table-header text-right">Kostua (€)</th>
                                    <th class="table-header text-center">Amort. Urteak</th>
                                    <th class="table-header text-right">Urteko Amortizazioa (€)</th>
                                </tr>
                            </thead>
                            <tbody id="lokala-amortizable-body" class="bg-white divide-y divide-gray-200">
                                <!-- JS-k beteko du -->
                            </tbody>
                        </table>
                    </div>

                    <!-- B) GASTU ERREPIKARI FINKOAK TABLE -->
                    <h3 class="text-xl font-semibold text-indigo-600 mb-4 mt-8 flex items-center">
                        B) Gastu Errepikari Finko Nagusiak
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 rounded-xl overflow-hidden">
                            <thead class="bg-indigo-50">
                                <tr>
                                    <th class="table-header">Kontzeptua (UR)</th>
                                    <th class="table-header text-right">Ordainketa Kostua (€)</th>
                                    <th class="table-header text-center">Maiztasuna (Urteko Aldiak)</th>
                                    <th class="table-header text-right">Urteko Guztizkoa (€)</th>
                                </tr>
                            </thead>
                            <tbody id="lokala-recurring-body" class="bg-white divide-y divide-gray-200">
                                <!-- JS-k beteko du -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- EMAITZEN LABURPENA (Lokala) -->
                <div class="lg:col-span-1 space-y-6">
                    <h3 class="text-2xl font-bold text-gray-700 pb-2 border-b-2 border-gray-300">Laburpen Ekonomikoa (1. Fitxa)</h3>

                    <div class="result-card border-indigo-600">
                        <p class="text-sm font-medium text-indigo-600 uppercase">Lokalaren Inbertsio Osoa</p>
                        <p id="total-local-investment" class="text-3xl font-extrabold text-indigo-800 mt-1">0.00</p>
                    </div>

                    <div class="result-card border-green-500">
                        <p class="text-sm font-medium text-green-600 uppercase">Urteko Amortizazio Kostua</p>
                        <p id="total-local-amortization" class="text-3xl font-extrabold text-green-800 mt-1">0.00</p>
                    </div>

                    <div class="result-card border-yellow-500">
                        <p class="text-sm font-medium text-yellow-600 uppercase">Urteko Gastu Finko Errepikariak</p>
                        <p id="total-local-recurring" class="text-3xl font-extrabold text-yellow-800 mt-1">0.00</p>
                    </div>

                    <div class="result-card bg-indigo-100 border-indigo-900">
                        <p class="text-sm font-medium text-indigo-800 uppercase">Lokalaren Urteko Kostu FINKOA</p>
                        <p id="total-local-annual-cost" class="text-4xl font-extrabold text-indigo-900 mt-1">0.00</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ################################### -->
        <!-- 2. PERTSONALAREN KOSTUAK (FINKOAK) -->
        <!-- ################################### -->
        <div id="pertsonala-sheet" class="hidden">
            <h2 class="text-2xl font-bold text-gray-700 mb-6 border-b pb-2 text-pink-600">2. Pertsonalaren Kostuak (Gastu Finko Errepikariak)</h2>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Langileen taula -->
                <div class="lg:col-span-2">
                    <h3 class="text-xl font-semibold text-pink-600 mb-4 flex items-center">
                        Langile Bakotzaren Kostu Osoa (Urteko)
                    </h3>
                    <div class="overflow-x-auto mb-8">
                        <table class="min-w-full divide-y divide-gray-200 rounded-xl overflow-hidden">
                            <thead class="bg-pink-50">
                                <tr>
                                    <th class="table-header">Funtzioa / Izena</th>
                                    <th class="table-header text-right">Soldata Gordina (Urteko €)</th>
                                    <th class="table-header text-center">Gizarte Seg. (% Empresa)</th>
                                    <th class="table-header text-right">Kostu Osoa Empresarentzat (€)</th>
                                    <th class="table-header w-10"></th>
                                </tr>
                            </thead>
                            <tbody id="personnel-body" class="bg-white divide-y divide-gray-200">
                                <!-- JS-k beteko du -->
                            </tbody>
                        </table>
                    </div>
                    <button onclick="addPersonnel()" class="px-4 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 transition duration-150">
                        + Langile Berria Gehitu
                    </button>
                    <!-- Pertsonalaren Laburpena -->
                    <div class="mt-8 result-card bg-pink-100 border-pink-600">
                        <p class="text-sm font-medium text-pink-600 uppercase">Pertsonalaren Kostu Osoa (Urteko)</p>
                        <p id="total-personnel-cost" class="text-3xl font-extrabold text-pink-800 mt-1">€ 0.00</p>
                    </div>
                </div>
                <!-- SOLDATA GARBIAREN KALKULUA -->
                <div id="net-salary-calculator" class="lg:col-span-1 p-6 bg-gray-50 rounded-xl border-2 border-gray-200">
                    <h3 class="text-xl font-bold text-gray-700 mb-4 flex items-center border-b pb-2">
                        Soldata Garbiaren Kalkulagailua (Langilearen Kenkariak)
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label for="grossSalary" class="block text-sm font-medium text-gray-700 mb-1">Soldata Gordina Urtekoa (€):</label>
                            <input type="number" id="grossSalary" value="25000" min="0" class="input-style p-3 text-xl bg-pink-50 font-bold" oninput="calculateNetSalary()" placeholder="Adibidez: 25000">
                        </div>
                        <div>
                            <label for="irpfRate" class="block text-sm font-medium text-gray-700 mb-1">PFEZ Atxikipen Portzentajea (%):</label>
                            <input type="number" id="irpfRate" value="15" min="0" max="100" class="input-style p-3 text-xl bg-pink-50 font-bold" oninput="calculateNetSalary()" placeholder="Adibidez: 15">
                        </div>
                        <div class="p-3 bg-red-100 rounded-lg border border-red-300">
                            <p class="text-sm font-medium text-red-700">GS Kenkaria (Langileak) (6.35%):</p>
                            <span id="ssDeduction" class="text-xl font-bold text-red-700 block mt-1">0.00</span>
                        </div>
                        <div class="p-4 bg-green-200 rounded-lg border border-green-400 mt-4">
                            <span class="text-lg font-semibold text-green-800">Soldata Garbia Hilekoa (14 ordainketa):</span>
                            <span id="netMonthlySalary" class="text-2xl font-extrabold text-green-800 block mt-1">0.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ############################################## -->
        <!-- 3. EKOIZPEN GASTU ALDAKORRAK -->
        <!-- ############################################## -->
        <div id="ekoizpena-sheet" class="hidden">
            <h2 class="text-2xl font-bold text-gray-700 mb-6 border-b pb-2 text-green-600">3. Ekoizpen Gastuak (Aldakorrak)</h2>
            <p class="text-sm text-gray-500 mb-6">Zuzenean lan-bolumenarekin lotutako gastuak (Materialak, Azpikontratak, EZA gehigarria).</p>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- EKOIZPEN GASTU ERREPIKARIAK TABLE -->
                <div class="lg:col-span-2 space-y-8">
                    <h3 class="text-xl font-semibold text-green-600 mb-4 flex items-center">
                        Proiektuaren arabera aldatzen diren gastuak
                    </h3>
                    <div class="overflow-x-auto mb-10">
                        <table class="min-w-full divide-y divide-gray-200 rounded-xl overflow-hidden">
                            <thead class="bg-green-50">
                                <tr>
                                    <th class="table-header">Kontzeptua (UR)</th>
                                    <th class="table-header text-right">Ordainketa Kostua (€)</th>
                                    <th class="table-header text-center">Maiztasuna (Urteko Aldiak)</th>
                                    <th class="table-header text-right">Urteko Guztizkoa (€)</th>
                                </tr>
                            </thead>
                            <tbody id="ekoizpena-recurring-body" class="bg-white divide-y divide-gray-200">
                                <!-- JS-k beteko du -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- LABURPENA -->
                <div class="lg:col-span-1 space-y-6">
                    <h3 class="text-2xl font-bold text-gray-700 pb-2 border-b-2 border-gray-300">Laburpen Ekonomika (3. Fitxa)</h3>
                    <div class="result-card bg-green-100 border-green-600">
                        <p class="text-sm font-medium text-green-600 uppercase">Ekoizpen Gastu Aldakorrak (Urteko)</p>
                        <p id="total-production-cost" class="text-3xl font-extrabold text-green-800 mt-1">€ 0.00</p>
                        <p class="text-xs text-gray-500 mt-2">Gastu aldakorrak aurrekontuaren bolumen estandarraren arabera.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ##################################### -->
        <!-- 4. GARRATOAREN GASTUAK -->
        <!-- ##################################### -->
        <div id="garraioa-sheet" class="hidden">
            <h2 class="text-2xl font-bold text-gray-700 mb-6 border-b pb-2 text-red-600">4. Garraioaren Gastuak</h2>
            <p class="text-sm text-gray-500 mb-6">Lanari lotutako ibilgailuaren inbertsioa eta gastu errepikariak.</p>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- GARRATOA TAULAK -->
                <div class="lg:col-span-2 space-y-8">
                    <!-- Garraioa: Inbertsioa (Amortizagarria) -->
                    <h3 class="text-xl font-semibold text-red-600 mb-4 flex items-center">
                        A) Inbertsio Amortizagarriak (Ibilgailuaren Erosketa)
                    </h3>
                    <div class="overflow-x-auto mb-10">
                        <table class="min-w-full divide-y divide-gray-200 rounded-xl overflow-hidden">
                            <thead class="bg-red-50">
                                <tr>
                                    <th class="table-header">Kontzeptua (AM)</th>
                                    <th class="table-header text-right">Kostua (€)</th>
                                    <th class="table-header text-center">Amort. Urteak</th>
                                    <th class="table-header text-right">Urteko Amortizazioa (€)</th>
                                </tr>
                            </thead>
                            <tbody id="garraioa-amortizable-body" class="bg-white divide-y divide-gray-200">
                                <!-- JS-k beteko du -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Garraioa: Gastu Errepikariak -->
                    <h3 class="text-xl font-semibold text-red-600 mb-4 flex items-center">
                        B) Gastu Errepikariak (Erregaia, Asegurua, Mantentzea)
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 rounded-xl overflow-hidden">
                            <thead class="bg-red-50">
                                <tr>
                                    <th class="table-header">Kontzeptua (UR)</th>
                                    <th class="table-header text-right">Ordainketa Kostua (€)</th>
                                    <th class="table-header text-center">Maiztasuna (Urteko Aldiak)</th>
                                    <th class="table-header text-right">Urteko Guztizkoa (€)</th>
                                </tr>
                            </thead>
                            <tbody id="garraioa-recurring-body" class="bg-white divide-y divide-gray-200">
                                <!-- JS-k beteko du -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- LABURPENA -->
                <div class="lg:col-span-1 space-y-6">
                    <h3 class="text-2xl font-bold text-gray-700 pb-2 border-b-2 border-gray-300">Laburpen Ekonomika (4. Fitxa)</h3>
                    <div class="result-card border-red-600">
                        <p class="text-sm font-medium text-red-600 uppercase">Garraioaren Inbertsio Osoa</p>
                        <p id="total-transport-investment" class="text-3xl font-extrabold text-red-800 mt-1">€ 0.00</p>
                    </div>
                    <div class="result-card bg-red-100 border-red-800">
                        <p class="text-sm font-medium text-red-800 uppercase">Garraioaren Urteko Kostu Osoa</p>
                        <p id="total-transport-annual-cost" class="text-3xl font-extrabold text-red-900 mt-1">€ 0.00</p>
                        <p class="text-xs text-gray-500 mt-2">Amortizazioa + Gastu Errepikariak.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ################################## -->
        <!-- 5. HAZKUNTZA ETA MARKETIN GASTUAK (NEGOZIO SORTZAILEAK) -->
        <!-- ################################## -->
        <div id="hazkuntza-sheet" class="hidden">
            <h2 class="text-2xl font-bold text-gray-700 mb-6 border-b pb-2 text-purple-600">5. Hazkuntza eta Marketin Gastuak</h2>
            <p class="text-sm text-gray-500 mb-6">Epe luzeko hazkunderako inbertsio estrategikoak (prestakuntza, publizitatea, harpidetzak).</p>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- HAZKUNTZA GASTU ERREPIKARIAK TABLE -->
                <div class="lg:col-span-2 space-y-8">
                    <h3 class="text-xl font-semibold text-purple-600 mb-4 flex items-center">
                        Prestakuntza, Harpidetzak eta Komunikazio Kanpainak
                    </h3>
                    <div class="overflow-x-auto mb-10">
                        <table class="min-w-full divide-y divide-gray-200 rounded-xl overflow-hidden">
                            <thead class="bg-purple-50">
                                <tr>
                                    <th class="table-header">Kontzeptua (UR)</th>
                                    <th class="table-header text-right">Ordainketa Kostua (€)</th>
                                    <th class="table-header text-center">Maiztasuna (Urteko Aldiak)</th>
                                    <th class="table-header text-right">Urteko Guztizkoa (€)</th>
                                </tr>
                            </thead>
                            <tbody id="hazkuntza-recurring-body" class="bg-white divide-y divide-gray-200">
                                <!-- JS-k beteko du -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- LABURPENA -->
                <div class="lg:col-span-1 space-y-6">
                    <h3 class="text-2xl font-bold text-gray-700 pb-2 border-b-2 border-gray-300">Laburpen Ekonomika (5. Fitxa)</h3>
                    <div class="result-card bg-purple-100 border-purple-600">
                        <p class="text-sm font-medium text-purple-600 uppercase">Hazkuntza eta Marketin Gastuak (Urteko)</p>
                        <p id="total-growth-cost" class="text-3xl font-extrabold text-purple-800 mt-1"></p>
                        <p class="text-xs text-gray-500 mt-2">Sortzaileak diren inbertsio estrategikoak.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ##################################### -->
        <!-- 6. FINANTZAKETA MAILEGUA -->
        <!-- ##################################### -->
        <div id="finantzaketa-sheet" class="hidden">
            <h2 class="text-2xl font-bold text-gray-700 mb-6 border-b pb-2 text-blue-600">6. Finantzaketa Mailegua</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Maileguaren Sarrera Datuak -->
                <div class="space-y-6">
                    <h3 class="text-xl font-semibold text-blue-600 mb-4">Maileguaren Baldintzak</h3>
                    
                    <div>
                        <label for="loan-principal" class="block text-sm font-medium text-gray-700">Maileguaren Zenbateko Nagusia (€)</label>
                        <input type="number" id="loan-principal" value="0" min="0" class="input-style bg-blue-50 text-xl font-bold mt-1" oninput="updateLoanCalculation()">
                        <p class="text-xs text-gray-500 mt-1">Proiektuko kostu osoarekin sinkronizatuta dago lehenetsiz.</p>
                    </div>
                    
                    <div>
                        <label for="loan-tae" class="block text-sm font-medium text-gray-700">TAE (Tasa Anual Equivalente) (%)</label>
                        <input type="number" id="loan-tae" value="5.0" min="0" max="100" step="0.1" class="input-style bg-blue-50 text-xl font-bold mt-1" oninput="updateLoanCalculation()">
                    </div>
                    
                    <div>
                        <label for="loan-term" class="block text-sm font-medium text-gray-700">Iraupena Urtetan</label>
                        <input type="number" id="loan-term" value="5" min="1" max="50" step="1" class="input-style bg-blue-50 text-xl font-bold mt-1" oninput="updateLoanCalculation()">
                        <p class="text-xs text-gray-500 mt-1">Amortizazio osoa: <span id="loan-term-months"></span> hilabete</p>
                    </div>
                </div>
                
                <!-- Kalkulatutako Emaitzak -->
                <div class="space-y-6">
                    <h3 class="text-xl font-semibold text-blue-600 mb-4">Finantzaketaren Emaitzak</h3>
                    
                    <div class="result-card bg-blue-50 border-blue-600">
                        <p class="text-sm font-medium text-blue-600 uppercase">Maileguaren Zenbateko Nagusia</p>
                        <p id="loan-principal-display" class="text-2xl font-extrabold text-blue-800 mt-1">€ 0.00</p>
                    </div>
                    
                    <div class="result-card bg-blue-100 border-blue-700">
                        <p class="text-sm font-medium text-blue-700 uppercase">Hileroko Kuota (Amortizazioa + Interesa)</p>
                        <p id="loan-monthly-payment" class="text-2xl font-extrabold text-blue-900 mt-1">€ 0.00</p>
                    </div>
                    
                    <div class="result-card bg-orange-50 border-orange-600">
                        <p class="text-sm font-medium text-orange-600 uppercase">Ordaindu beharreko Interes Osoa</p>
                        <p id="loan-total-interest" class="text-2xl font-extrabold text-orange-800 mt-1">€ 0.00</p>
                    </div>
                    
                    <div class="result-card bg-red-100 border-red-800">
                        <p class="text-sm font-medium text-red-800 uppercase">Urteko Finantza Gastua (Laburpenerako)</p>
                        <p id="loan-annual-interest" class="text-2xl font-extrabold text-red-900 mt-1">€ 0.00</p>
                        <p class="text-xs text-gray-500 mt-2">* Urteko Finantza Gastu hau automatikoki erabiltzen da "Finantza Laburpena" pestainan urteko fakturazio helburua kalkulatzeko.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ################################################## -->
        <!-- LABURPEN OROKORRA (Beheko Alde FINKOA) -->
        <!-- ################################################## -->
        <div class="mt-12 pt-8 border-t-4 border-indigo-400">
            <h2 class="text-3xl font-extrabold text-gray-800 mb-6">AURREKONTUAREN LABURPEN OROKORRA</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="result-card bg-blue-50 border-blue-600">
                    <p class="text-sm font-medium text-blue-600 uppercase">Urteko Gastu FINKO Osoa</p>
                    <p id="total-fixed-annual-cost" class="text-3xl font-extrabold text-blue-800 mt-1">€ 0.00</p>
                    <p class="text-xs text-gray-500 mt-2">Lokal Finko + Amortizazio osoa + Pertsonala.</p>
                </div>
                
                <div class="result-card bg-orange-50 border-orange-600">
                    <p class="text-sm font-medium text-orange-600 uppercase">Urteko Gastu Aldakor/Estrategikoa</p>
                    <p id="total-variable-annual-cost" class="text-3xl font-extrabold text-orange-800 mt-1">€ 0.00</p>
                    <p class="text-xs text-gray-500 mt-2">Ekoizpen Aldakorrak + Garraio Errepikariak + Hazkuntza/Marketina.</p>
                </div>
                
                <div class="result-card bg-indigo-700 border-indigo-900">
                    <p class="text-sm font-medium text-indigo-200 uppercase">GASTU OPERATIBO GUZTIZKOA (URTEKO)</p>
                    <p id="total-operational-cost" class="text-4xl font-extrabold text-white mt-1">€ 0.00</p>
                    <p class="text-xs text-indigo-300 mt-2">Gastu guztiak barne (Amortizazioak eta Errepikariak).</p>
                </div>
            </div>
        </div>

        <!-- FINANTZIAZIOA ETA KAPITALIZAZIOA (Guztizkoa) - BETI AZKEN EMAITZA NAGUSIA BEZALA -->
        <hr class="my-10 border-t-4 border-indigo-200" />
        <div id="finantzaketa-section" class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div>
                <h2 class="text-2xl font-bold text-gray-700 mb-6 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2v8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                    Finantziazio Behar Osoa
                </h2>
                <div class="result-card bg-red-50 border-red-600 mb-6">
                    <p class="text-sm font-medium text-red-600 uppercase">Inbertsio Osoa (Lokala + Garraioa)</p>
                    <p id="total-investment-display" class="text-3xl font-extrabold text-red-800 mt-1">0.00</p>
                    <p class="text-xs text-gray-500 mt-2">amortizagari guztien batura.</p>
                </div>
                <div class="result-card bg-orange-50 border-orange-600 mb-6">
                    <p class="text-sm font-medium text-orange-600 uppercase">Kapitalizazio Beharra (Finantzatu beharreko Hilabeteak)</p>
                    <p id="initial-capital-needed" class="text-3xl font-extrabold text-orange-800 mt-1">0.00</p>
                    <div class="mt-4">
                        <label for="initial-months" class="block text-sm font-medium text-gray-700"><b>Hasieran Finantzatu Beharreko Hilabete Kopurua:</b></label>
                        <input type="number" id="initial-months" value="3" min="0" max="12" class="input-style bg-white text-xl font-bold p-2" oninput="updateCalculation()">
                        <p class="text-xs text-gray-500 mt-1">operatibo errepikari guztien gainean aplikatua.</p>
                    </div>
                </div>
                <div class="result-card bg-red-100 border-red-800">
                    <p class="text-sm font-medium text-red-800 uppercase">FINANTZIAZIO BEHAR OSOA (Inbertisioa + Kapitalizazioa)</p>
                    <p id="finance-needed-total" class="text-4xl font-extrabold text-red-900 mt-1"></p>
                </div>
            </div>

            <!-- Finantzaketa Iturrien Sarrera eta Balantzea -->
            <div class="space-y-6">
                <h3 class="text-xl font-semibold text-gray-700">Finantzaketa Iturriak Sartu</h3>

                <div>
                    <label for="partner-capital" class="block text-sm font-medium text-gray-700">Bazkideen Kapital/Aurrezki Ekarpena (€)</label>
                    <input type="number" id="partner-capital" value="0" min="0" class="input-style bg-green-50 text-2xl font-bold mt-1" oninput="updateCalculation()">
                </div>

                <div>
                    <label for="bank-loan" class="block text-sm font-medium text-gray-700">Banku Maileguaren Zenbatekoa (€)</label>
                    <input type="number" id="bank-loan" value="0" min="0" class="input-style bg-green-50 text-2xl font-bold mt-1" oninput="updateCalculation()">
                </div>

                <h3 class="text-xl font-semibold text-gray-700 mt-8">Finantzaketaren Emaitza</h3>

                <div class="result-card bg-green-100 border-green-600">
                    <p class="text-sm font-medium text-green-600 uppercase">Finantzaketa Osoa (Sortutakoa)</p>
                    <p id="total-finance-raised" class="text-3xl font-extrabold text-green-800 mt-1"></p>
                </div>

                <div id="balance-card" class="result-card border-gray-400">
                    <p class="text-sm font-medium text-gray-700 uppercase">Oreka / Geratzen den Zenbatekoa</p>
                    <p id="finance-balance" class="text-3xl font-extrabold text-gray-800 mt-1"></p>
                    <p id="balance-message" class="text-xs mt-2 text-gray-500"></p>
                </div>
            </div>
        </div>
    </section>
</div>

<script>
    // --- DATUEN EGITURA (5 kategoria berriekin eta EZA banatuta) ---
    
    // Inbertsio Amortizagarriak (AM): 'lokala' eta 'garraioa'
    let amortizableItems = [
        // LOKALA
        { id: 'lokala-erosketa', name: 'Lokalaren Erosketa (Amortizagarria)', cost: 120000, years: 20, category: 'lokala' },
        { id: 'erreforma-balioa', name: 'Erreformaren Balioa (Amortizagarria)', cost: 30000, years: 10, category: 'lokala' },
        { id: 'altzarien-erosketa', name: 'Altzarien Erosketa', cost: 8000, years: 5, category: 'lokala' },
        { id: 'hw-sw-hornitzea', name: 'Hardware eta Softwarearen Hornitzea', cost: 4000, years: 4, category: 'lokala' },
        // GARRAIOA
        { id: 'kotxea-erosketa', name: 'Garraio Ibilgailuaren Erosketa', cost: 20000, years: 5, category: 'garraioa' },
    ];

    // Gastu Errepikariak (UR): 'lokala', 'ekoizpena', 'garraioa', 'hazkuntza'
    let recurringItems = [
        // 1. LOKALA (GASTU FINKOAK)
        { id: 'alokairua', name: 'Alokairua (Hilekoa)', payment_cost: 800, frequency: 12, category: 'lokala' },
        { id: 'hornigaiak-finko', name: 'Hornigaiak: Gutxieneko Kontsumoa (Argia, Ura)', payment_cost: 100, frequency: 12, category: 'lokala' },
        { id: 'ezf-urteroko-prima', name: 'Erantzukizun Zibileko Asegurua (Urteko Prima FINKOA)', payment_cost: 600, frequency: 1, category: 'lokala' }, // PRIMA FINKOA HEMEN
        { id: 'zergak-tasak', name: 'Zergak eta Udal Tasak (Lokala)', payment_cost: 1200, frequency: 1, category: 'lokala' },
        { id: 'aseguruak-lokala', name: 'Bestelako Aseguruak (Lokala)', payment_cost: 450, frequency: 1, category: 'lokala' },
        { id: 'telefonia-internet-finko', name: 'Telefonia eta Internet FINKOA', payment_cost: 80, frequency: 12, category: 'lokala' },
        // 3. EKOIZPEN GASTU ALDAKORRAK
        { id: 'ezf-proiektu-gehigarria', name: 'EZA (Proiektu Bakoitzeko Gehigarria)', payment_cost: 200, frequency: 12, category: 'ekoizpena' }, // GEHIGARRIA HEMEN
        { id: 'hirugarrenen-lanak-ekoizpen', name: 'Hirugarrenen Lan Laguntzaileak (Proiektuko Azpikontratak)', payment_cost: 1500, frequency: 12, category: 'ekoizpena' },
        { id: 'material-gordinak', name: 'Material Gordinak / Kontsumigarri Espezifikoak', payment_cost: 400, frequency: 12, category: 'ekoizpena' },
        { id: 'elkargo-kuotak-ekoizpena', name: 'Elkargo Tasak (Jarduerari lotuak)', payment_cost: 150, frequency: 1, category: 'ekoizpena' },
        // 4. GARRAIOA
        { id: 'garraio-mantentzea', name: 'Garraioa: Mantentze-lanak eta Konponketak', payment_cost: 500, frequency: 1, category: 'garraioa' },
        { id: 'garraio-zergak', name: 'Garraioa: Udal Tasak eta Zergak (Urteko)', payment_cost: 150, frequency: 1, category: 'garraioa' },
        { id: 'garraio-asegurua', name: 'Garraioa: Asegurua (Urteko)', payment_cost: 500, frequency: 1, category: 'garraioa' },
        { id: 'garraio-erregaia', name: 'Garraioa: Erregaia / Gasolina', payment_cost: 250, frequency: 12, category: 'garraioa' },
        { id: 'dietak', name: 'Dietak / Bazkariak (Desplazamenduak)', payment_cost: 150, frequency: 12, category: 'garraioa' },
        // 5. HAZKUNTZA ETA MARKETINA
        { id: 'prestakuntza-saioak', name: 'Prestakuntza Saioak eta Ikastaroak', payment_cost: 800, frequency: 1, category: 'hazkuntza' },
        { id: 'aldizkari-harpidetzak', name: 'Aldizkari eta Ikerketa Harpidetzak', payment_cost: 100, frequency: 12, category: 'hazkuntza' },
        { id: 'komunikazio-sareak', name: 'Komunikazioa Sareetan / Marketing digitala', payment_cost: 300, frequency: 12, category: 'hazkuntza' },
        { id: 'patrozinioak', name: 'Patrozinioak / Networking Ekitaldiak', payment_cost: 500, frequency: 1, category: 'hazkuntza' },
    ];

    let personnel = [
        { id: Date.now() + 1, name: 'Zuzendaria / Bazkidea', salary: 35000, ss_percent: 30 },
    ];

    // Maileguaren datuak
    let loanData = {
        principal: 0,
        tae: 5.0,
        termYears: 5,
        monthlyPayment: 0,
        totalInterest: 0,
        annualInterest: 0
    };

    // --- FUNTZIO OROKORRAK ---
    /**
     * Zenbaki bat bi hamartarrekin formateatzen du.
     */
    const formatCurrency = (number) => {
        const num = parseFloat(number) || 0;
        return new Intl.NumberFormat('eu-ES', { style: 'currency', currency: 'EUR' }).format(num);
    };

    /**
     * Fitxa bat erakutsi eta besteak ezkutatzen ditu.
     */
    window.showSheet = function(sheetName) {
        // Ezkutatu guztiak
        document.getElementById('lokala-sheet').classList.add('hidden');
        document.getElementById('pertsonala-sheet').classList.add('hidden');
        document.getElementById('ekoizpena-sheet').classList.add('hidden');
        document.getElementById('garraioa-sheet').classList.add('hidden');
        document.getElementById('hazkuntza-sheet').classList.add('hidden');
        document.getElementById('finantzaketa-sheet').classList.add('hidden');

        // Desaktibatu botoi guztiak
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('tab-active');
            btn.classList.add('tab-inactive');
        });

        // Erakutsi hautatutakoa eta aktibatu botoia
        document.getElementById(`${sheetName}-sheet`).classList.remove('hidden');
        document.getElementById(`tab-${sheetName}`).classList.remove('tab-inactive');
        document.getElementById(`tab-${sheetName}`).classList.add('tab-active');

        updateCalculation();
    };

    // --- MAILEGUAREN KALKULUAK ---
    window.updateLoanCalculation = function() {
        // Datuak jaso
        loanData.principal = parseFloat(document.getElementById('loan-principal').value) || 0;
        loanData.tae = parseFloat(document.getElementById('loan-tae').value) || 0;
        loanData.termYears = parseInt(document.getElementById('loan-term').value) || 1;

        // Hilabete kopurua eguneratu
        document.getElementById('loan-term-months').textContent = (loanData.termYears * 12).toLocaleString('eu-ES');

        // Kalkuluak egin
        calculateLoan();

        // Emaitzak erakutsi
        document.getElementById('loan-principal-display').textContent = formatCurrency(loanData.principal);
        document.getElementById('loan-monthly-payment').textContent = formatCurrency(loanData.monthlyPayment);
        document.getElementById('loan-total-interest').textContent = formatCurrency(loanData.totalInterest);
        document.getElementById('loan-annual-interest').textContent = formatCurrency(loanData.annualInterest);

        updateCalculation();
    };

    function calculateLoan() {
        const P = loanData.principal; // Nagusia
        const T = loanData.termYears * 12; // Epea hilabeteetan
        const i = (loanData.tae / 100) / 12; // Hileroko interes tasa

        let monthlyPayment = 0;
        let totalInterest = 0;

        if (P > 0 && T > 0 && i > 0) {
            // Hileroko kuota kalkulatzea (Frantziako sistema)
            monthlyPayment = P * i * (Math.pow(1 + i, T) / (Math.pow(1 + i, T) - 1));
            totalInterest = (monthlyPayment * T) - P;
        } else if (P > 0 && T > 0 && i === 0) {
            // Interesik gabeko mailegua
            monthlyPayment = P / T;
            totalInterest = 0;
        }

        loanData.monthlyPayment = monthlyPayment;
        loanData.totalInterest = totalInterest;
        // Urteko Interes Batez Bestekoa (Laburpenerako)
        loanData.annualInterest = totalInterest / (loanData.termYears > 0 ? loanData.termYears : 1);
    }

    // --- TAULAK SORTZEKO FUNTZIO NAGUSIA ---
    const renderTable = (data, tbodyId, category, isAmortizable) => {
        const tbody = document.getElementById(tbodyId);
        if (!tbody) return;
        tbody.innerHTML = '';

        const filteredData = data.filter(item => item.category === category);

        filteredData.forEach(item => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';

            let annualCost = 0;
            if (isAmortizable) {
                annualCost = item.years > 0 ? item.cost / item.years : 0;
            } else {
                annualCost = item.payment_cost * item.frequency;
            }
            const costInputId = `${item.id}-${isAmortizable ? 'cost' : 'payment-cost'}`;
            const secondaryInputId = `${item.id}-${isAmortizable ? 'years' : 'frequency'}`;
            const annualCostCellId = `${item.id}-annual-cost`;

            if (isAmortizable) {
                // Amortizagarrien errenkada
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-700">${item.name}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900 w-1/4">
                        <input type="number" id="${costInputId}" data-id="${item.id}" data-type="cost" value="${item.cost}" min="0" class="input-style text-right bg-indigo-50" oninput="updateCalculation()">
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900 w-1/6">
                        <input type="number" id="${secondaryInputId}" data-id="${item.id}" data-type="years" value="${item.years}" min="1" class="input-style text-center" oninput="updateCalculation()">
                    </td>
                    <td id="${annualCostCellId}" class="px-3 py-2 whitespace-nowrap text-sm font-bold text-gray-800 text-right bg-indigo-100">
                        ${formatCurrency(annualCost)}
                    </td>
                `;
            } else {
                // Errepikarien errenkada
                row.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-700">${item.name}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900 w-1/4">
                        <input type="number" id="${costInputId}" data-id="${item.id}" data-type="payment_cost" value="${item.payment_cost}" min="0" class="input-style text-right bg-indigo-50" oninput="updateCalculation()">
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900 w-1/6">
                        <input type="number" id="${secondaryInputId}" data-id="${item.id}" data-type="frequency" value="${item.frequency}" min="1" class="input-style text-center" oninput="updateCalculation()">
                    </td>
                    <td id="${annualCostCellId}" class="px-3 py-2 whitespace-nowrap text-sm font-bold text-gray-800 text-right bg-indigo-100">
                        ${formatCurrency(annualCost)}
                    </td>
                `;
            }
            tbody.appendChild(row);
        });
    };

    // Funtzio laguntzaileak taulak marrazteko
    const renderLocalAmortizableTable = () => renderTable(amortizableItems, 'lokala-amortizable-body', 'lokala', true);
    const renderLocalRecurringTable = () => renderTable(recurringItems, 'lokala-recurring-body', 'lokala', false);
    const renderProductionRecurringTable = () => renderTable(recurringItems, 'ekoizpena-recurring-body', 'ekoizpena', false);
    const renderTransportAmortizableTable = () => renderTable(amortizableItems, 'garraioa-amortizable-body', 'garraioa', true);
    const renderTransportRecurringTable = () => renderTable(recurringItems, 'garraioa-recurring-body', 'garraioa', false);
    const renderGrowthRecurringTable = () => renderTable(recurringItems, 'hazkuntza-recurring-body', 'hazkuntza', false);

    // --- PERTSONAL FUNTZIOAK ---
    /** Langileen taula marraztu. */
    const renderPersonnelTable = () => {
        const tbody = document.getElementById('personnel-body');
        if (!tbody) return;
        tbody.innerHTML = '';

        personnel.forEach(p => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';

            const ssCost = p.salary * (p.ss_percent / 100);
            const totalCost = p.salary + ssCost;

            row.innerHTML = `
                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-700">
                    <input type="text" id="personnel-name-${p.id}" data-id="${p.id}" data-field="name" value="${p.name}" class="input-style p-1 text-sm bg-pink-50" oninput="updateCalculation()">
                </td>
                <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900 w-1/5">
                    <input type="number" id="personnel-salary-${p.id}" data-id="${p.id}" data-field="salary" value="${p.salary}" min="0" class="input-style text-right bg-pink-50" oninput="updateCalculation()">
                </td>
                <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900 w-1/6">
                    <div class="flex items-center">
                        <input type="number" id="personnel-ss-${p.id}" data-id="${p.id}" data-field="ss_percent" value="${p.ss_percent}" min="0" max="100" class="input-style text-center bg-pink-50 w-full" oninput="updateCalculation()">
                        <span class="ml-1 text-gray-500">%</span>
                    </div>
                </td>
                <td id="personnel-total-${p.id}" class="px-3 py-2 whitespace-nowrap text-sm font-bold text-gray-800 text-right bg-pink-100 w-1/4">
                    ${formatCurrency(totalCost)}
                </td>
                <td class="px-1 py-2 text-center w-10">
                    <button onclick="removePersonnel(${p.id})" class="text-red-500 hover:text-red-700 transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    };

    /**
     * Langile berria gehitzen du datu-egituran.
     */
    window.addPersonnel = function() {
        personnel.push({
            id: Date.now(),
            name: 'Langile Berria',
            salary: 20000,
            ss_percent: 30
        });
        updateCalculation();
    };

    /**
     * Langile bat ezabatzen du datu-egituratik.
     */
    window.removePersonnel = function(id) {
        personnel = personnel.filter(p => p.id != id);
        updateCalculation();
    };

    // --- SOLDATA GARBIAREN KALKULUA (Funtzio isolatua) ---
    window.calculateNetSalary = function() {
        const grossSalary = parseFloat(document.getElementById('grossSalary')?.value) || 0;
        const irpfRate = parseFloat(document.getElementById('irpfRate')?.value) || 0;

        if (grossSalary < 0 || irpfRate < 0 || irpfRate > 100) return;

        // Gizarte Segurantza (Langilearen ekarpena) 6.35%
        const SS_RATE = 0.0635;
        const ssDeduction = grossSalary * SS_RATE;
        // PFEZ
        const irpfDeduction = grossSalary * (irpfRate / 100);

        const netAnnualSalary = grossSalary - ssDeduction - irpfDeduction;

        const monthlyPayments = 14;
        const netMonthlySalary = netAnnualSalary / monthlyPayments;

        // Emaitzak erakutsi
        document.getElementById('ssDeduction').textContent = formatCurrency(ssDeduction);
        document.getElementById('netMonthlySalary').textContent = formatCurrency(netMonthlySalary);
    };

    // --- KALKULU NAGUSIA (GLOBAL) ---
    window.updateCalculation = function() {
        let totalInvestment = 0;
        let totalAnnualAmortization = 0;

        // Kategoriako batuketen hasieratzea
        let totalLocalInvestment = 0;
        let totalLocalAmortization = 0;
        let totalLocalRecurring = 0;

        let totalTransportInvestment = 0;
        let totalTransportAmortization = 0;
        let totalTransportRecurring = 0;

        let totalProductionRecurring = 0;
        let totalGrowthRecurring = 0;

        // 1. INBERTSIOEN ETA AMORTIZAZIOEN DATUAK EGUNERATU ETA KALKULATU (Lokala + Garraioa)
        amortizableItems.forEach(item => {
            const costInput = document.getElementById(`${item.id}-cost`);
            const yearsInput = document.getElementById(`${item.id}-years`);

            if(costInput && yearsInput) {
                item.cost = parseFloat(costInput.value) || 0;
                item.years = parseInt(yearsInput.value) > 0 ? parseInt(yearsInput.value) : 1;
            }
            const annualAmortization = item.cost / item.years;
            totalInvestment += item.cost;
            totalAnnualAmortization += annualAmortization;

            // Kategoria especifikoak batzeko
            if (item.category === 'lokala') {
                totalLocalInvestment += item.cost;
                totalLocalAmortization += annualAmortization;
            } else if (item.category === 'garraioa') {
                totalTransportInvestment += item.cost;
                totalTransportAmortization += annualAmortization;
            }
            const annualCostCell = document.getElementById(`${item.id}-annual-cost`);
            if(annualCostCell) annualCostCell.textContent = formatCurrency(annualAmortization);
        });

        // 2. GASTU ERREPIKARIEN DATUAK EGUNERATU ETA KALKULATU (4 kategoria)
        recurringItems.forEach(item => {
            const paymentCostInput = document.getElementById(`${item.id}-payment-cost`);
            const frequencyInput = document.getElementById(`${item.id}-frequency`);

            if(paymentCostInput && frequencyInput) {
                item.payment_cost = parseFloat(paymentCostInput.value) || 0;
                item.frequency = parseInt(frequencyInput.value) > 0 ? parseInt(frequencyInput.value) : 1;
            }

            const annualCost = item.payment_cost * item.frequency;

            // Kategoria esperifikoak batzeko
            if (item.category === 'lokala') {
                totalLocalRecurring += annualCost;
            } else if (item.category === 'ekoizpena') {
                totalProductionRecurring += annualCost;
            } else if (item.category === 'garraioa') {
                totalTransportRecurring += annualCost;
            } else if (item.category === 'hazkuntza') {
                totalGrowthRecurring += annualCost;
            }

            const annualCostCell = document.getElementById(`${item.id}-annual-cost`);
            if(annualCostCell) annualCostCell.textContent = formatCurrency(annualCost);
        });

        // 3. PERTSONALAREN KOSTUAK EGUNERATU
        let totalPersonnelCost = 0;

        personnel.forEach(p => {
            const salaryInput = document.getElementById(`personnel-salary-${p.id}`);
            const ssInput = document.getElementById(`personnel-ss-${p.id}`);

            if(salaryInput && ssInput) {
                p.salary = parseFloat(salaryInput.value) || 0;
                p.ss_percent = Math.min(100, Math.max(0, parseFloat(ssInput.value) || 0));
                ssInput.value = p.ss_percent;
            }
            const ssCost = p.salary * (p.ss_percent / 100);
            const totalCost = p.salary + ssCost;

            totalPersonnelCost += totalCost;

            const totalCell = document.getElementById(`personnel-total-${p.id}`);
            if (totalCell) totalCell.textContent = formatCurrency(totalCost);
        });

        // ---
        // LABURPENAK BISTARATU
        // ---

        // 1. Lokalaren laburpena
        document.getElementById('total-local-investment').textContent = formatCurrency(totalLocalInvestment);
        document.getElementById('total-local-amortization').textContent = formatCurrency(totalLocalAmortization);
        document.getElementById('total-local-recurring').textContent = formatCurrency(totalLocalRecurring);
        const totalLocalAnnualCost = totalLocalAmortization + totalLocalRecurring;
        document.getElementById('total-local-annual-cost').textContent = formatCurrency(totalLocalAnnualCost);

        // 2. Personalaren laburpena
        document.getElementById('total-personnel-cost').textContent = formatCurrency(totalPersonnelCost);

        // 3. Ekoizpenaren laburpena
        document.getElementById('total-production-cost').textContent = formatCurrency(totalProductionRecurring);

        // 4. Garraioaren laburpena
        document.getElementById('total-transport-investment').textContent = formatCurrency(totalTransportInvestment);
        const totalTransportAnnualCost = totalTransportAmortization + totalTransportRecurring;
        document.getElementById('total-transport-annual-cost').textContent = formatCurrency(totalTransportAnnualCost);

        // 5. Hazkuntzaren laburpena
        document.getElementById('total-growth-cost').textContent = formatCurrency(totalGrowthRecurring);

        // LABURPEN OROKORRA

        // Inbertisio Osoa (Lokala + Garraioa inbertsioak)
        document.getElementById('total-investment-display').textContent = formatCurrency(totalInvestment);

        // Gastu Finko Osoa (Amortizazio guztiak, Lokal Finkoek eta Pertsonala)
        // Orain FINKOA = Amortizazio osoa + Lokal Errepikariak + Pertsonalaren Kostua
        const totalFixedAnnualCost = totalAnnualAmortization + totalLocalRecurring + totalPersonnelCost;
        document.getElementById('total-fixed-annual-cost').textContent = formatCurrency(totalFixedAnnualCost);

        // Gastu Aldakor/Estrategika (Ekoizpena, Garraio Errepikaria, Hazkuntza)
        const totalVariableAnnualCost = totalProductionRecurring + totalTransportRecurring + totalGrowthRecurring;
        document.getElementById('total-variable-annual-cost').textContent = formatCurrency(totalVariableAnnualCost);

        // Guztizko Gastu Operatibo Utrekoa (Guztien batura)
        const totalOperationalCost = totalFixedAnnualCost + totalVariableAnnualCost;
        document.getElementById('total-operational-cost').textContent = formatCurrency(totalOperationalCost);

        // ---
        // FINANTZIAZIOA (Kapitalizazioa eta Balantzea)
        // ---

        // Kapitalizazioa Gastu Errepikarien gainean (Amortizazioak ez)
        const totalRecurringOperatingCost = totalLocalRecurring + totalPersonnelCost + totalProductionRecurring + totalTransportRecurring + totalGrowthRecurring;
        const totalMonthlyOperatingCost = totalRecurringOperatingCost / 12;

        const initialMonthsInput = document.getElementById('initial-months');
        const initialMonths = parseFloat(initialMonthsInput?.value) || 0;

        // Hasierako Kapitalizazio Beharra
        const initialCapitalNeeded = totalMonthlyOperatingCost * initialMonths;
        document.getElementById('initial-capital-needed').textContent = formatCurrency(initialCapitalNeeded);

        // Finantziazio Behar Osoa
        const totalFinanceNeeded = totalInvestment + initialCapitalNeeded;
        document.getElementById('finance-needed-total').textContent = formatCurrency(totalFinanceNeeded);

        // Ekarpenak eta Oreka
        const partnerCapital = parseFloat(document.getElementById('partner-capital').value) || 0;
        const bankLoan = parseFloat(document.getElementById('bank-loan').value) || 0;
        const totalFinanceRaised = partnerCapital + bankLoan;
        document.getElementById('total-finance-raised').textContent = formatCurrency(totalFinanceRaised);

        const balance = totalFinanceRaised - totalFinanceNeeded;
        document.getElementById('finance-balance').textContent = formatCurrency(Math.abs(balance));

        const balanceCard = document.getElementById('balance-card');
        const balanceMessage = document.getElementById('balance-message');

        balanceCard.classList.remove('border-red-600', 'border-blue-600', 'bg-red-50', 'bg-blue-50', 'border-gray-400', 'bg-white');

        if (balance > 0) {
            balanceCard.classList.add('border-blue-600', 'bg-blue-50');
            balanceMessage.textContent = "Finantziazio behar osoa gainditu da. Soberakina dago.";
        } else if (balance < 0) {
            balanceCard.classList.add('border-red-600', 'bg-red-50');
            balanceMessage.textContent = "Finantziazio defizita dago. Kapital gehiago sartu beharra dago.";
        } else {
            balanceCard.classList.add('border-gray-400', 'bg-white');
            balanceMessage.textContent = "Finantziazioa eta behar osoa bat datoz.";
        }

        // Soldata Garbiaren kalkulua beti eguneratu
        calculateNetSalary();
    };

    // --- HASIERATZEA ---
    window.onload = function() {
        // Taulak marraztu hasieran
        renderLocalAmortizableTable();
        renderLocalRecurringTable();
        renderPersonnelTable();
        renderProductionRecurringTable();
        renderTransportAmortizableTable();
        renderTransportRecurringTable();
        renderGrowthRecurringTable();

        // Lehen kalkulua exekutatu
        updateCalculation();
        updateLoanCalculation();

        // Hasierako fitxa erakutsi
        showSheet('lokala');
    };
</script>

</body>
</html>
